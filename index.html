<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width = device-width, initial-scale = 1">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="index.css" />
	<link rel="stylesheet" type="text/css" href="common.css">
	<title>IWMI</title>
</head>

<body>
	<a href="https://github.com/lthiamodelers/IWMI-Refresh"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
	<div class="container" style="height:100%;width:100%;">
		<nav class="navbar navbar-default" style="width: calc(100% - 150px);">
			<div class="container-fluid" style="height:100%;width:100%;">
				<div class="navbar-header"> <a class="navbar-brand" href="#">IWMI</a> </div>
				<div id="navbar" class="navbar-collapse collapse">
					<ul class="nav navbar-nav">
						<li class="active"><a href="#" id="mapNav">Map</a></li>
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li id="loginNav"><a href="login.html">Login</a></li>
					</ul>
				</div>
			</div>
		</nav>
		<div id="parent">
			<div id="map"></div>
			<div id="searchTools" class="container">
				<h2 style="margin:5px auto;width:50%;">Search Tools</h2>
				<div class="form-group">
					<label for="city">City</label>
					<input type="text" class="form-control" id="city">
					<button type="submit" id="searchCity" class="btn btn-lg btn-primary btn-block">Search</button>
				</div>
				<hr/>
				<div class="form-group">
					<select id="agencyTypeSelect" class="form-control">
						<option>Select Agency Type</option>
					</select>
				</div>
			</div>
		</div>
	</div>
	<script src="lib/papaparse.js"></script>
	<script src="lib/markerclusterer.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script>
		var infowindow;
		var map;
		var agencyNames = [];
		var agencyTypes = [];
		var locations = [];

		function Location(oldLocation, point, marker) {
			this.FID = oldLocation.FID;
			this.GID = oldLocation.GID;
			this.type = oldLocation.type;
			this.organization = oldLocation.organization;
			this.name = oldLocation.name;
			this.siteNo = oldLocation.siteNo;
			this.description = oldLocation.description;
			this.parameterType = oldLocation.parameterType;
			this.parameter = oldLocation.parameter;
			this.frequency = oldLocation.frequency;
			this.public = oldLocation.public;
			this.startDate = oldLocation.startDate;
			this.endDate = oldLocation.endDate;
			this.contactURL = oldLocation.contactURL;
			this.id = oldLocation.id;
			this.quality = oldLocation.quality;
			this.email = oldLocation.email;
			this.huc8 = oldLocation.huc8;
			this.huc10 = oldLocation.huc10;
			this.huc12 = oldLocation.huc12;
			this.lat = oldLocation.lat;
			this.lng = oldLocation.lng;
			this.point = point;
			this.marker = marker;
		}

		function OldLocation(FID, GID, type, organization, name, siteNo, description, parameterType, parameter, frequency, public, startDate, endDate, contactURL, id, quality, email, huc8, huc10, huc12, lat, lng) {
			this.FID = FID;
			this.GID = GID;
			this.type = type;
			this.organization = organization;
			this.name = name;
			this.siteNo = siteNo;
			this.description = description;
			this.parameterType = parameterType;
			this.parameter = parameter;
			this.frequency = frequency;
			this.public = public;
			this.startDate = startDate;
			this.endDate = endDate;
			this.contactURL = contactURL;
			this.id = id;
			this.quality = quality;
			this.email = email;
			this.huc8 = huc8;
			this.huc10 = huc10;
			this.huc12 = huc12;
			this.lat = lat;
			this.lng = lng;
		}

		function populateAgencyType() {
			var agencyTypeSelect = document.getElementById("agencyTypeSelect");
			for (var i = 0; i < agencyTypes.length - 1; i++) {
				var type = agencyTypes[i];
				var el = document.createElement("option");
				console.log("Type: " + type);
				el.textContent = type;
				el.value = type;
				agencyTypeSelect.appendChild(el);
			}
		}


		function addAgencyType(loc) {
			//Could we find the agency type in the array?
			var found = false;

			//Loop through each agency type in the agencyNames array.
			for (var i = 0; i < agencyNames.length; i++) {
				//Check if agencyNames has type in it.
				if (agencyNames[i][0] === loc.type) {
					//Is the name of the agency already in the array?
					if (agencyNames[i].indexOf(loc.organization) == -1) {
						//Append the name of the agency to the array, if it isn't in there already.
						agencyNames[i].push(loc.organization);
					}

					//We found the agency type!
					found = true;
					//Get out of this array
					break;
				}
			}

			if (found === false) {
				//Couldn't find the agency type in the array.
				//Make a new array
				var arr = [];
				//Put the type, and then the name of the agency into the array
				arr.push(loc.type);
				arr.push(loc.organization);
				//Push the array, and the type to agencyNames, and agencyTypes, respectively
				agencyNames.push(arr);
				agencyTypes.push(loc.type);
			}
		}

		function parse(text) {
			console.log("Length of saved data: " + JSON.parse(localStorage.getItem("locations")).length);
			locations = JSON.parse(localStorage.getItem("locations"));
			if (locations === null || locations.length < 100) {

				var data = Papa.parse(text);
				for (var i = 1; i < data.data.length; i++) {
					var a = data.data[i];

					var loc = new OldLocation(a[0], a[1], a[2], a[3], a[4], a[5], a[6], a[7], a[8], a[9], a[10], a[11], a[12], a[13], a[14], a[15], a[16], a[17], a[18], a[19], a[20], a[21]);

					var point = {
						lat: parseFloat(loc.lat),
						lng: parseFloat(loc.lng)
					}

					var marker = new google.maps.Marker({
						position: loc.point,
						icon: {
							path: google.maps.SymbolPath.CIRCLE,
							scale: 5
						},
						title: loc.name
					});

					var newLoc = new Location(loc, point, marker);

					locations.push(newLoc);
				}
			}
			myMap();
		}

		function myMap() {
			//Google search "Indianapolis, IN lat long". Will be used as the center point.
			var center = {
				lat: 39.7684,
				lng: -86.1581
			};

			//Create the map with refrence to the #map element.
			var mapCanvas = document.getElementById("map");
			var mapOptions = {
				center: center,
				zoom: 8
			};

			//Base URL for the circle icon used as a marker.
			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			map = new google.maps.Map(mapCanvas, mapOptions);

			//Empty array to put the markers in as they are created. This will be used to make a markerClusterer
			var markers = [];

			var totalTime = 0;

			for (var i = 0; i < locations.length; i++) {
				var loc = locations[i];
				addAgencyType(loc);

				var start = new Date().getTime();


				var end = new Date().getTime();
				totalTime = totalTime + (end - start);

				markers.push(loc.marker);
				if (i == 0) {
					console.log(loc.marker);
					console.log()
				}

				//A closure to make sure that infoWindows are created for their own markers.
				(function(_marker) {

					//An attempt to close the previously opened window.
					if (infowindow) infowindow.close();


					var content = '<h5><a href="' + loc.contactURL + '">' + loc.name + '</a></h5><p><b>Agency:</b> ' + loc.organization + '<br><b>Location:</b> ' + loc.description + '<br><b>Site Number:</b> ' + loc.siteNo + '<br><b>Parameter(s) sampled:</b> ' + loc.parameter + '<br><b>Parameter Type:</b> ' + loc.parameterType + '<br><b>Monitoring Frequency:</b> ' + loc.frequency + '<br><b>Publicly Availible?:</b> ' + loc.public + '<br><b>Data Quality Information:</b> ' + loc.quality + '<br><b>Date of record:</b> ' + loc.startDate + ' to ' + loc.endDate + '<br><b>HUC12:</b> ' + loc.huc12 + '</p>';

					//Create the info window based on the content variable ^^
					var infowindow = new google.maps.InfoWindow({
						content: content,
						maxWidth: 400
					});

					//Add the on click listener to the marker.
					_marker.addListener('click', function() {
						infowindow.open(map, _marker);
					});

				}(loc.marker));
			}

			console.log("Time: " + totalTime);

			agencyTypes.sort();

			console.log(agencyTypes);

			// Add a marker clusterer to manage the markers.
			var markerCluster = new MarkerClusterer(map, markers, {
				imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
				maxZoom: 15 //An arbitrary value that seems to work well.
			});

			populateAgencyType();

			console.log(locations);

			var items = JSON.parse(localStorage.getItem("locations"));
			if (items === null || items.length < 100) {
				console.log("Saving!!");
				localStorage.setItem("locations", JSON.stringify(locations));
			}

		}



		//click function for search
		function searchCity() {

			var geocoder = new google.maps.Geocoder();
			var input = document.getElementById("city");
			var cityAndState = input.value + ", IN";

			geocoder.geocode({
				'address': cityAndState
			}, function(results, status) {

				if (status == google.maps.GeocoderStatus.OK) {

					console.log("location: " + results[0].geometry.location.lat() + " " + results[0].geometry.location.lng());
					map.setCenter(new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng()));
					map.setZoom(13);
				}
			});
		};

		function populateAgencyType() {
			var agencyTypeSelect = document.getElementById("agencyTypeSelect");
			for (var i = 0; i < agencyTypes.length; i++) {
				var type = agencyTypes[i];
				var el = document.createElement("option");
				el.textContent = type;
				el.value = type;
				agencyTypeSelect.appendChild(el);
			}
		}

		document.getElementById("searchCity").addEventListener("click", searchCity);
		document.getElementById("agencyTypeSelect").addEventListener("click", populateAgencyType);

		//Load in the csv, and call myMap with it.
		$(document).ready(function() {
			$.ajax({
				type: "GET",
				url: "res/inwater.csv",
				dataType: "text",
				success: function(data) {
					parse(data);
				}
			})

		});

	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASiSo-iDClClxEHgAGFYGvz55dAXIYJWw&callback=myMap"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>

</html>
